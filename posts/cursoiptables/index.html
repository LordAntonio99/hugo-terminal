<!doctype html><html lang=en>
<head>
<title>Curso completo de iptables :: La web de Antonio</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Contenidos  Filtrado de paquetes  iptables firewalls NAT SNAT DNAT    Filtrado de paquetes Se pueden realizar filtrados en base a diferentes capas del modelo TCP/IP. Sirven para poder controlar el tipo de tráfico que hay en nuestra red, permitir y denegar tráfico, y analizarlo.
iptables Puede trabajar con ip6tables, ebtables y arptables. Es el proyecto más utilizado y no se desarrollan ya nuevas funcionalidades. El proyecto nftables esta desarrollado por los creadores de iptables, y es el sucesor de iptables, ip6tables, arptables y ebtables.">
<meta name=keywords content=",">
<meta name=robots content="noodp">
<link rel=canonical href=https://lordantonio99.github.io/hugo-terminal/posts/cursoiptables/>
<link rel=stylesheet href=https://lordantonio99.github.io/hugo-terminal/assets/style.css>
<link rel=stylesheet href=https://lordantonio99.github.io/hugo-terminal/assets/pink.css>
<link rel=apple-touch-icon href=https://lordantonio99.github.io/hugo-terminal/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://lordantonio99.github.io/hugo-terminal/img/favicon/pink.png>
<meta name=twitter:card content="summary">
<meta name=twitter:site content>
<meta name=twitter:creator content>
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Curso completo de iptables">
<meta property="og:description" content="Contenidos  Filtrado de paquetes  iptables firewalls NAT SNAT DNAT    Filtrado de paquetes Se pueden realizar filtrados en base a diferentes capas del modelo TCP/IP. Sirven para poder controlar el tipo de tráfico que hay en nuestra red, permitir y denegar tráfico, y analizarlo.
iptables Puede trabajar con ip6tables, ebtables y arptables. Es el proyecto más utilizado y no se desarrollan ya nuevas funcionalidades. El proyecto nftables esta desarrollado por los creadores de iptables, y es el sucesor de iptables, ip6tables, arptables y ebtables.">
<meta property="og:url" content="https://lordantonio99.github.io/hugo-terminal/posts/cursoiptables/">
<meta property="og:site_name" content="La web de Antonio">
<meta property="og:image" content="https://lordantonio99.github.io/hugo-terminal/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:published_time" content="2022-02-03 15:41:27 +0100 +0100">
</head>
<body class=pink>
<div class="container full headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=https://lordantonio99.github.io/hugo-terminal/>
<div class=logo>
Antonio
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=https://lordantonio99.github.io/hugo-terminal/about>About</a></li>
<li><a href=https://lordantonio99.github.io/hugo-terminal/showcase>Showcase</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=https://lordantonio99.github.io/hugo-terminal/about>About</a></li>
<li><a href=https://lordantonio99.github.io/hugo-terminal/showcase>Showcase</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://lordantonio99.github.io/hugo-terminal/posts/cursoiptables/>Curso completo de iptables</a></h1>
<div class=post-meta>
<span class=post-date>
2022-02-03
</span>
</div>
<span class=post-tags>
#<a href=https://lordantonio99.github.io/hugo-terminal/tags/firewall/>firewall</a>&nbsp;
#<a href=https://lordantonio99.github.io/hugo-terminal/tags/iptables/>iptables</a>&nbsp;
#<a href=https://lordantonio99.github.io/hugo-terminal/tags/redes/>redes</a>&nbsp;
#<a href=https://lordantonio99.github.io/hugo-terminal/tags/ciberseguridad/>ciberseguridad</a>&nbsp;
</span>
<div class=post-content><div>
<h1 id=contenidos>Contenidos<a href=#contenidos class=hanchor arialabel=Anchor>&#8983;</a> </h1>
<ul>
<li><a href=#filtrado-de-paquetes>Filtrado de paquetes</a>
<ul>
<li><a href=#iptables>iptables</a></li>
<li><a href=#firewalls>firewalls</a></li>
<li><a href=#nat>NAT</a></li>
<li><a href=#snat>SNAT</a></li>
<li><a href=#dnat>DNAT</a></li>
</ul>
</li>
</ul>
<h2 id=filtrado-de-paquetes>Filtrado de paquetes<a href=#filtrado-de-paquetes class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>Se pueden realizar filtrados en base a diferentes capas del modelo TCP/IP. Sirven para poder controlar el tipo de tráfico que hay en nuestra red, permitir y denegar tráfico, y analizarlo.</p>
<h3 id=iptables>iptables<a href=#iptables class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>Puede trabajar con ip6tables, ebtables y arptables. Es el proyecto más utilizado y no se desarrollan ya nuevas funcionalidades.
El proyecto nftables esta desarrollado por los creadores de iptables, y es el sucesor de iptables, ip6tables, arptables y ebtables.</p>
<h3 id=firewalls>Firewalls<a href=#firewalls class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>Sistema de seguridad que inspecciona el tráfico de red, seleccionando el conforme a unas reglas establecidas.
El paquete de iptables proporciona algunas funcionalidades extra que no tienen los firewalls, como la NAT.</p>
<h3 id=nat>NAT<a href=#nat class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<p>Sirve principalmente para:</p>
<ul>
<li>Un equipo con dirección privada que quiere salir a internet (SNAT)</li>
<li>Un equipo que quiere acceder a un servicio ubicado en una dirección privada (DNAT)</li>
</ul>
<h4 id=snat>SNAT<a href=#snat class=hanchor arialabel=Anchor>&#8983;</a> </h4>
<p>Es la más comun para acceder a redes de Internet desde una red privada. Un dispositivo de NAT modifica la ip privada de origen por una ip pública. Puede utilizarse también entre redes privadas para no generar demasiadas reglas estáticas.</p>
<h4 id=dnat>DNAT<a href=#dnat class=hanchor arialabel=Anchor>&#8983;</a> </h4>
<p>Se utiliza para exponer un servicio que está en una ip privada. Un dispositivo NAT modifica la ip pública de una petición para un servicio, asignandole una ip privada de dentro del servidor.</p>
<h2 id=esquema-de-red>Esquema de red<a href=#esquema-de-red class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p><img src=/hugo-terminal/img/esquemaiptables.png alt="Esquema de red">
Puedes descargar la OVA para VirtualBox <a href="https://drive.google.com/file/d/1cG1Vcl5aioI28A_fGbzV8-pcCXI5PRYv/view?usp=sharing">aqui</a></p>
<h2 id=tipos-de-tráfico>Tipos de tráfico<a href=#tipos-de-tráfico class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<ul>
<li>Entrante: tráfico entrante con destino al equipo</li>
<li>Salida: tráfico saliente con origen en el equipo</li>
<li>Paso: tráfico que atraviesa el equipo, entra por una interfaz y sale por otra</li>
</ul>
<h2 id=tablas-de-iptables>Tablas de iptables<a href=#tablas-de-iptables class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<ul>
<li>filter: cortafuegos, es la tabla por defecto.</li>
<li>nat: para hacer NAT.</li>
<li>mangle: marcar y modificar paquetes.</li>
<li>raw: depurar seguimiento de conexión.</li>
<li>security: usadas para MAC.</li>
</ul>
<h3 id=cadenas-de-filter>Cadenas de filter<a href=#cadenas-de-filter class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>INPUT: tráfico entrante</li>
<li>OUTPUT: tráfico saliente</li>
<li>FORWARD: tráfico de paso</li>
</ul>
<h3 id=cadenas-de-nat>Cadenas de nat<a href=#cadenas-de-nat class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>PREROUTING: relacionada con DNAT. Modifica la ip de destino.</li>
<li>INPUT</li>
<li>OUTPUT</li>
<li>POSTROUTING: relacinada con SNAT. Modifica la ip de paquetes de salida.</li>
</ul>
<h3 id=tipo-de-tráfico-y-flujo>Tipo de tráfico y flujo<a href=#tipo-de-tráfico-y-flujo class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<ul>
<li>Paquete del exterior con destino el equipo: PREROUTING de nat e INPUT de filter.</li>
<li>Paquete originado en el equipo que sale: OUTPUT de nat, OUTPUT de filter y POSTROUTING de nat.</li>
<li>Paquete que atraviesa el equipo: PREROUTING de nat, FORWARD de filter y POSTROUTING de nat.</li>
</ul>
<h2 id=sintaxis>Sintaxis<a href=#sintaxis class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<h3 id=políticas>Políticas<a href=#políticas class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>iptables <span style=color:#f92672>[</span>-t TABLA<span style=color:#f92672>]</span> -P <span style=color:#f92672>[</span>CADENA<span style=color:#f92672>]</span> ACCEPT|DROP
</code></pre></div><h3 id=listar-reglas>Listar reglas<a href=#listar-reglas class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>iptables -L <span style=color:#f92672>[</span>CADENA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-n<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-v<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>--line-numbers<span style=color:#f92672>]</span>
iptables -S <span style=color:#f92672>[</span>CADENA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-v<span style=color:#f92672>]</span>
</code></pre></div><h3 id=añadir-reglas>Añadir reglas<a href=#añadir-reglas class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>iptables -A <span style=color:#f92672>[</span>CADENA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-p PROTOCOLO<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-s IP ORIGEN<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-d IP DESTINO<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-i INTERFAZ ENTRADA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-o INTERFAZ SALIDA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-j ACCEPT|DROP<span style=color:#f92672>]</span> <span style=color:#75715e>#Inserta al final</span>
iptables -I <span style=color:#f92672>[</span>CADENA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-p PROTOCOLO<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-s IP ORIGEN<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-d IP DESTINO<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-i INTERFAZ ENTRADA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-o INTERFAZ SALIDA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-j ACCEPT|DROP<span style=color:#f92672>]</span> <span style=color:#75715e>#Inserta al principio</span>
</code></pre></div><h3 id=borrar-reglas>Borrar reglas<a href=#borrar-reglas class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>iptables -C <span style=color:#f92672>[</span>CADENA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-p PROTOCOLO<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-s IP ORIGEN<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-d IP DESTINO<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-i INTERFAZ ENTRADA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-o INTERFAZ SALIDA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-j ACCEPT|DROP<span style=color:#f92672>]</span> <span style=color:#75715e>#Comprueba si la regla existe</span>
iptables -D <span style=color:#f92672>[</span>CADENA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-p PROTOCOLO<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-s IP ORIGEN<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-d IP DESTINO<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-i INTERFAZ ENTRADA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-o INTERFAZ SALIDA<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-j ACCEPT|DROP<span style=color:#f92672>]</span> <span style=color:#75715e>#Borra una regla</span>
</code></pre></div><h3 id=limpiar>Limpiar<a href=#limpiar class=hanchor arialabel=Anchor>&#8983;</a> </h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>iptables -F <span style=color:#f92672>[</span>CADENA<span style=color:#f92672>]</span> <span style=color:#75715e># Borra todas las reglas</span>
iptables -Z <span style=color:#75715e>#Pone los contadores a 0</span>
</code></pre></div><p><strong>Ejemplo de reglas para iptables personales</strong></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># HTTP</span>
iptables -A INPUT -i enp0s3 -p tcp --sport <span style=color:#ae81ff>80</span> -j ACCEPT
iptables -A OUTPUT -o enp0s3 -p tcp --dport <span style=color:#ae81ff>80</span> -j ACCEPT
<span style=color:#75715e># HTTPS</span>
iptables -A INPUT -i enp0s3 -p tcp --sport <span style=color:#ae81ff>443</span> -j ACCEPT
iptables -A OUTPUT -o enp0s3 -p tcp --dport <span style=color:#ae81ff>443</span> -j ACCEPT
<span style=color:#75715e># DNS</span>
iptables -A INPUT -i enp0s3 -p udp --sport <span style=color:#ae81ff>53</span> -j ACCEPT
iptables -A OUTPUT -o enp0s3 -p udp --dport <span style=color:#ae81ff>53</span> -j ACCEPT
</code></pre></div><h2 id=configuración-del-firewall-perimetral-1>Configuración del firewall perimetral 1<a href=#configuración-del-firewall-perimetral-1 class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># Activar en el router el reenvio de paquetes entre interfaces</span>
echo <span style=color:#ae81ff>1</span> &gt; /proc/sys/net/ipv4/ip_forward
<span style=color:#75715e># Borrar todas las reglas</span>
iptables -F
<span style=color:#75715e># Politicas por defecto en DROP</span>
iptables -P INPUT DROP
iptables -P OUTPUT DROP
iptables -P FORWARD DROP
<span style=color:#75715e># Permitir el ping por la NAT</span>
iptables -A OUTPUT -o enp0s3 -p icmp -j ACCEPT
iptables -A INPUT -i enp0s3 -p icmp -j ACCEPT
<span style=color:#75715e># Permitir el ping del servidor a las demas maquinas y viceversa</span>
iptables -A OUTPUT -o enp0s8 -s 192.168.100.0/24 -p icmp -j ACCEPT
iptables -A INPUT -i enp0s8 -s 192.168.100.0/24 -p icmp -j ACCEPT
iptables -A OUTPUT -o enp0s9 -s 192.168.200.0/24 -p icmp -j ACCEPT
iptables -A INPUT -i enp0s9 -s 192.168.200.0/24 -p icmp -j ACCEPT
<span style=color:#75715e># Permitir el ping entre las máquinas</span>
iptables -A FORWARD -i enp0s8 -o enp0s9 -p icmp -J ACCEPT
iptables -A FORWARD -o enp0s8 -i enp0s9 -p icmp -J ACCEPT
<span style=color:#75715e># Redirigir el trafico DNS</span>
iptables -A FORWARD -i enp0s8 -o enp0s3 -s 192.168.100.0/24 -p udp --dport <span style=color:#ae81ff>53</span> -j ACCEPT
iptables -A FORWARD -o enp0s8 -i enp0s3 -d 192.168.100.0/24 -p udp --sport <span style=color:#ae81ff>53</span> -j ACCEPT
<span style=color:#75715e># Aceptar trafico web</span>
iptables -A FORWARD -i enp0s8 -o enp0s3 -s 192.168.100.0/24 -p tcp --dport <span style=color:#ae81ff>80</span> -j ACCEPT
iptables -A FORWARD -o enp0s8 -i enp0s3 -d 192.168.100.0/24 -p tcp --sport <span style=color:#ae81ff>80</span> -j ACCEPT
iptables -A FORWARD -i enp0s9 -o enp0s3 -s 192.168.200.0/24 -p tcp --dport <span style=color:#ae81ff>443</span> -j ACCEPT
iptables -A FORWARD -o enp0s9 -i enp0s3 -d 192.168.200.0/24 -p tcp --sport <span style=color:#ae81ff>443</span> -j ACCEPT
iptables -A FORWARD -i enp0s8 -o enp0s3 -s 192.168.100.0/24 -p tcp --dport <span style=color:#ae81ff>80</span> -j ACCEPT
iptables -A FORWARD -o enp0s8 -i enp0s3 -d 192.168.100.0/24 -p tcp --sport <span style=color:#ae81ff>80</span> -j ACCEPT
iptables -A FORWARD -i enp0s9 -o enp0s3 -s 192.168.200.0/24 -p tcp --dport <span style=color:#ae81ff>443</span> -j ACCEPT
iptables -A FORWARD -o enp0s9 -i enp0s3 -d 192.168.200.0/24 -p tcp --sport <span style=color:#ae81ff>443</span> -j ACCEPT
<span style=color:#75715e>#SNAT</span>
iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o enp0s3 -j MASQUERADE
<span style=color:#75715e>#DNAT</span>
iptables -t nat -A PREROUTING -i enp0s8 -p tcp --dport <span style=color:#ae81ff>80</span> -j DNAT --to 192.168.200.2
</code></pre></div>
</div></div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button next">
<a href=https://lordantonio99.github.io/hugo-terminal/posts/servidoresdhcp/>
<span class=button__text>Servidores DHCP Teoría</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=copyright>
<span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span>
</div>
</div>
</footer>
<script src=https://lordantonio99.github.io/hugo-terminal/assets/main.js></script>
<script src=https://lordantonio99.github.io/hugo-terminal/assets/prism.js></script>
</div>
</body>
</html>